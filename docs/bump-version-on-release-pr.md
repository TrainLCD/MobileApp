# Bump Version on Release PR

`release/v*` ブランチからPRが開かれた際に、アプリのバージョンとビルド番号を自動更新するversion-bump PRを作成するワークフロー。

## トリガー

- `pull_request` の `opened` イベント
- 同一リポジトリからのPR かつ ヘッドブランチが `release/v` で始まる場合のみ実行

## ブランチ名の形式

以下の形式に対応している。

| 形式 | 例 | 正規化後 |
|---|---|---|
| `release/vX` | `release/v11` | `11.0.0` |
| `release/vX.Y` | `release/v10.1` | `10.1.0` |
| `release/vX.Y.Z` | `release/v10.1.2` | `10.1.2` |

不正な形式（`release/vfoo` など）はエラーとしてPRにコメントされる。

## バージョン決定ロジック

ブランチ名から抽出したバージョンと `package.json` の現在のバージョンを比較して、適用するバージョンを決定する。比較はブランチ名で明示された部分のみで行われる。

### パッチ未指定の場合（`release/vX` / `release/vX.Y`）

| 条件 | 結果 |
|---|---|
| 指定部分が現在より新しい | 正規化後のバージョンをそのまま使用 |
| 指定部分が現在と一致 | 現在のパッチ番号を+1 |
| 指定部分が現在より古い | エラー（PRにコメント） |

#### 例: `release/v10.1`（比較対象: major.minor のみ）

| 現在のバージョン | 結果 |
|---|---|
| `10.0.133` | `10.1.0`（minor が新しい → そのまま使用） |
| `10.1.5` | `10.1.6`（major.minor 一致 → パッチ+1） |
| `10.2.0` | エラー（minor が古い） |

### パッチ指定ありの場合（`release/vX.Y.Z`）

| 条件 | 結果 |
|---|---|
| 指定バージョンが現在より新しい | そのまま使用 |
| 指定バージョンが現在と完全一致 | エラー（PRにコメント） |
| 指定バージョンが現在より古い | エラー（PRにコメント） |

#### 例: `release/v10.1.2`（比較対象: major.minor.patch すべて）

| 現在のバージョン | 結果 |
|---|---|
| `10.0.5` | `10.1.2`（新しい → そのまま使用） |
| `10.1.2` | エラー（完全一致） |
| `10.2.0` | エラー（古い） |

## エラー時の動作

バージョンを決定できない場合、PRにコメントを残して処理を中止する。

| ステータス | コメント内容 |
|---|---|
| `invalid` | ブランチ名からバージョンを抽出できませんでした |
| `older` | 抽出したバージョンX.X.Xは現在のバージョンY.Y.Yより古いです |
| `same` | 抽出したバージョンX.X.Xは現在のバージョンと同一です |

## 成功時の動作

1. `pnpm run version:bump <バージョン>` を実行（ビルド番号は自動インクリメント）
2. `peter-evans/create-pull-request@v7` でversion-bump PRを作成
   - ブランチ: `auto-release-version-bump-<PR番号>`
   - ベースブランチ: PRのヘッドブランチ（`release/v*`）
   - ラベル: `automated`, `version-bump`
3. 作成されたPRをリリースブランチにマージすることでバージョンが更新される

## 関連ファイル

- `.github/workflows/bump_version_on_release_pr.yml` — ワークフロー本体
- `.github/workflows/bump_version_on_canary_pr.yml` — canary向けの類似ワークフロー
- `scripts/bump-version.js` — バージョン更新スクリプト
